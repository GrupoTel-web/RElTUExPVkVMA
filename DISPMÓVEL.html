<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/ico" href="rede.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Disponibilidade M√≥vel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
</head>
<body>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">


</head>
<body>
  <section class="hero-vivo" style="position: relative;">
    <div class="hero-overlay"></div>
    <div class="hero-content text-center my-4">
      <h1>Dashboard Disponibilidade - M√≥vel</h1>
    </div>
  
    <!-- Indicador de atualiza√ß√£o -->
    <div id="updateInfo" style="
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 1.7em;
      color: #fff;
      background-color: rgba(140, 0, 255, 0.5);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: bold;
    "></div>
  </section>

  <div class="container" style="margin-left: 50px; margin-right: -15px;">
    <div class="dashboard d-flex justify-content-between mb-4">
      <div class="dashboard-card total bg-primary text-white p-3 rounded" id="totalSitesCard">Total de Sites: 0</div>
      <div class="dashboard-card bg-secondary text-white p-3 rounded" id="sitesBairroCard">Total Sites Bairro: 0</div>
      <div class="dashboard-card red bg-danger text-white p-3 rounded" id="criticalSitesCard">Sites Cr√≠ticos: 0</div>
      <div class="dashboard-card yellow bg-warning text-white p-3 rounded" id="alertSitesCard">Sites em Alerta: 0</div>
      <div class="dashboard-card green bg-success text-white p-3 rounded" id="nonCriticalSitesCard">Sites N√£o Cr√≠ticos: 0</div>
    </div>

    <div class="d-flex justify-content-center mb-4">
      <button id="abiBtn" class="btn btn-outline-info mx-2" style="font-size:22px;font-weight:600;">ABI</button>
      <button id="telBtn" class="btn btn-outline-dark mx-2" style="font-size:22px;font-weight:600;">TEL</button>
      <button id="spiBtn" class="btn btn-outline-dark mx-2" style="font-size:22px;font-weight:600;">SPI</button>
    </div>

    <div class="search-card p-3 bg-none position-relative">
      <div class="row g-2">
        <div class="col-md-3 position-relative" style="border: none;">
          <input type="text" id="dddFilterInput" placeholder="" class="form-control input-large-bold" style="font-size:25px;font-weight:700;" readonly>
        </div>
        <div class="col-md-3 position-relative">
          <input type="text" id="muniFilterInput" placeholder="" class="form-control" style="font-size:25px;font-weight:700;" readonly>
        </div>
        <div class="col-md-3 position-relative">
          <input type="text" id="siteFilterInput" placeholder="" class="form-control" style="font-size:25px;font-weight:700;" readonly>
        </div>
        <div class="col-md-1">
          <button id="clearFilters" class="btn btn-secondary w-100" style="font-size:25px;font-weight:450;">Limpar</button>
        </div>
        <div class="col-md-1">
          <button id="exportExcel" class="btn btn-success w-100" style="font-size:25px;font-weight:450;">Exportar</button>
        </div>
        <div class="col-md-1">
          <button id="exportCausas" class="btn btn-info w-100" style="font-size:25px;font-weight:450;">Exportar Causas</button>
        </div>
      </div>
    </div>


    <div class="table-container bg-white rounded shadow-sm p-3 overflow-auto mt-3">
      <table id="oltTable" class="table table-striped table-bordered nowrap" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
      <div id="filterContainer"></div>
    </div>
  </div>


<div id="editModal" class="modal-overlay">
  <div class="modal-container">
    <button id="closeModalBtn" class="close-modal-btn">&times;</button>
    <h4 id="modalTitle" class="modal-title">Editar Informa√ß√£o</h4>
    <form id="editForm">


<div class="mb-2">
  <label class="form-label">‚ö†Ô∏è Causa 1</label>
  <select class="form-select" id="causaInput1">
    <option value="" disabled selected>Selecione uma causa</option>
    <option value="Rede Externa">Rede Externa</option>
    <option value="Vandalismo">Vandalismo</option>
    <option value="RF">RF</option>
    <option value="Energia AC">Energia AC</option>
    <option value="Infraestrutura">Infraestrutura</option>
    <option value="Equipamento">Equipamento</option>
    <option value="Transmiss√£o">Transmiss√£o</option>
    <option value="Software">Software</option>
    <option value="Implanta√ß√£o">Implanta√ß√£o</option>
    <option value="Outro">Outro</option>
  </select>
  <textarea class="form-control mt-2 auto-resize" id="causaOutro1" placeholder="Descreva a causa" style="display:none;" rows="1"></textarea>
  
</div><br>


<div class="mb-2">
  <label class="form-label">‚ö†Ô∏è Causa 2</label>
  <select class="form-select" id="causaInput2">
    <option value="" disabled selected>Selecione uma causa</option>
    <option value="Rede Externa">Rede Externa</option>
    <option value="Vandalismo">Vandalismo</option>
    <option value="RF">RF</option>
    <option value="Energia AC">Energia AC</option>
    <option value="Infraestrutura">Infraestrutura</option>
    <option value="Equipamento">Equipamento</option>
    <option value="Transmiss√£o">Transmiss√£o</option>
    <option value="Software">Software</option>
    <option value="Implanta√ß√£o">Implanta√ß√£o</option>
    <option value="Outro">Outro</option>
  </select>
  <textarea class="form-control mt-2 auto-resize" id="causaOutro2" placeholder="Descreva a causa" style="display:none;" rows="1"></textarea>
</div><br>

<div class="mb-2">
  <label class="form-label">‚ö†Ô∏è Causa 3</label>
  <select class="form-select" id="causaInput3">
    <option value="" disabled selected>Selecione uma causa</option>
    <option value="Rede Externa">Rede Externa</option>
    <option value="Vandalismo">Vandalismo</option>
    <option value="RF">RF</option>
    <option value="Energia AC">Energia AC</option>
    <option value="Infraestrutura">Infraestrutura</option>
    <option value="Equipamento">Equipamento</option>
    <option value="Transmiss√£o">Transmiss√£o</option>
    <option value="Software">Software</option>
    <option value="Implanta√ß√£o">Implanta√ß√£o</option>
    <option value="Outro">Outro</option>
  </select>
  <textarea class="form-control mt-2 auto-resize" id="causaOutro3" placeholder="Descreva a causa" style="display:none;" rows="1"></textarea>
</div>


<div class="mb-2">
  <label class="form-label">‚úÖ A√ß√£o Realizada</label>
  <textarea class="form-control auto-resize" id="solucaoInput" rows="1"></textarea>
</div>
<div class="mb-2">
  <label class="form-label">üßë‚Äçüíº Respons√°vel</label>
  <textarea class="form-control auto-resize" id="responsavelInput" rows="1"></textarea>
</div>
      <button type="button" id="editBtn" class="btn btn-secondary w-100 mt-2">Editar</button>
      <button type="submit" class="btn btn-primary w-100 mt-2">Salvar</button>
    </form>
    <div id="modalMsg" class="modal-msg">Salvo!</div>
  </div>
</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    function fetchWithCache(url, cacheKey, cacheDuration) {
      const cachedData = localStorage.getItem(cacheKey);
      const cacheTimestamp = localStorage.getItem(`${cacheKey}_timestamp`);
      const now = Date.now();

      if (cachedData && cacheTimestamp && (now - cacheTimestamp < cacheDuration * 1000)) {
        return Promise.resolve(JSON.parse(cachedData));
      }

      return fetch(url)
        .then(res => res.json())
        .then(data => {
          localStorage.setItem(cacheKey, JSON.stringify(data));
          localStorage.setItem(`${cacheKey}_timestamp`, now);
          return data;
        });
    }
    let dadosDisponibilidade = [];
    let dadosSitesBairro = [];
    let currentMonths = [];
    let table;
    let filtroDddPorBotao = false;
    let headCols = [];

    localStorage.removeItem('dadosDisponibilidade');
    localStorage.removeItem('dadosDisponibilidade_timestamp');
    localStorage.removeItem('dadosSitesBairro');
    localStorage.removeItem('dadosSitesBairro_timestamp');

    Promise.all([
      fetchWithCache('https://grupotel-web.github.io/RElTUExPVkVMA/dados.json', 'dadosDisponibilidade', 3600).then(d => dadosDisponibilidade = d),
      fetchWithCache('https://grupotel-web.github.io/RElTUExPVkVMA/sites.json', 'dadosSitesBairro', 3600).then(d => dadosSitesBairro = d)
    ]).then(() => {
      window.siteExtraMap = {};
      dadosSitesBairro.forEach(site => {
        if (site.Site) {
          const key = String(site.Site).trim().toUpperCase();
          window.siteExtraMap[key] = site;
        }
      });
      initializeTable();
      setupFilters();
      setupActions();
      setupAdvancedFilters();
    }).catch(err => console.error(err));

    function formatCell(value, rowIdx, colKey, colDisplay, site) {
  if (value == null || value === '') return `<td class="date-cell" data-row="${rowIdx}" data-colkey="${colKey}" data-coldisplay="${colDisplay}" data-site="${site}" style="cursor:pointer;"></td>`;

  const n = parseFloat(value.toString().replace(',', '.'));
  let bg = '', color = ''; 
  if (n === 100) {
    bg = '#337031'; color = '#fff';
  } else if (n > 98) {
    bg = '#00b050'; color = '#fff';
  } else if (n > 96) {
    bg = '#ffff00'; color = '#000';
  } else {
    bg = '#ff0000'; color = '#fff';
  }

  const disp = (n === 100 || n === 0) ? String(n) : n.toFixed(2).replace('.', ',');

  return `<td class="date-cell" style="background-color:${bg}; color:${color}; cursor:pointer;" data-order="${n}" data-row="${rowIdx}" data-colkey="${colKey}" data-coldisplay="${colDisplay}" data-site="${site}">${disp}</td>`;
}

    function getDynamicMonthHeaders(data) {
      const valid = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const keys = Object.keys(data[0] || {}).filter(k => valid.includes(k));
      const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      keys.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
      const monthMap = {
  Jan: 'Jan',
  Feb: 'Feb',
  Mar: 'Mar',
  Apr: 'Apr',
  May: 'May',
  Jun: 'Jun',
  Jul: 'Jul',
  Aug: 'Aug',
  Sep: 'Sep',
  Oct: 'Oct',
  Nov: 'Nov',
  Dec: 'Dez'
};

return keys.map(m => {
  if (!currentMonths.includes(m)) currentMonths.push(m);
  return { key: m, display: monthMap[m] || m };
});

    }
    function calculateColumns(item, monthHeaders) {
  const pv = v => v == null || v === '' ? null : parseFloat(v.toString().replace(',', '.'));

  const recentKeys = monthHeaders.slice(-4).map(h => h.key); 
  const recentVals = recentKeys.map(k => pv(item[k])).filter(v => v != null);

  const getCrit = trio => {
    const below96 = trio.map(v => v != null && v < 96 ? 1 : 0);
    const count = below96.reduce((a, b) => a + b, 0);
    if (count >= 2) return 'Cr√≠tico';
    if (count === 1 && below96[2] === 1) return 'Alerta';
    return 'N√£o Cr√≠tico';
  };

  const critical1 = getCrit(recentVals.slice(0, 3)); 
  const critical2 = getCrit(recentVals.slice(1));    

  return { critical1, critical2 };
}






function initializeTable() {
  const today = new Date();
  const dateHeaders = [];
  for (let i = 7; i >= 1; i--) {
    const d = new Date(today); d.setDate(d.getDate() - i);
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    dateHeaders.push({ key: `${dd}/${mm}/${d.getFullYear()}`, display: `Disp. ${dd}/${mm}` });
  }
  const monthHeaders = getDynamicMonthHeaders(dadosDisponibilidade);
  const lastMonths = monthHeaders.slice(-2);

  dadosDisponibilidade = dadosDisponibilidade.map(item => {
    const cols = calculateColumns(item, monthHeaders);
    let projMedia = item['PROJECAO_MEDIA'];
    if (projMedia === '' || projMedia === 0 || projMedia === '0') projMedia = '100';
    return { ...item,
      [`Criticidade ${lastMonths[0].display}`]: cols.critical1,
      [`Criticidade ${lastMonths[1].display}`]: cols.critical2,
      'Proj. M√©dia': projMedia
    };
  });

  headCols = [
    'DDD',
    'MUNICIPIO',
    'Qtd Bairros', // Adiciona a nova coluna ao cabe√ßalho
    'Parque',      // Adiciona a nova coluna ao cabe√ßalho
    'Bairros',
    'TAV?',
    'Bairro Alto Valor',
    'SITE',
    ...monthHeaders.map(m => m.display),
    ...dateHeaders.map(h => h.display),
    `Criticidade ${lastMonths[0].display}`,
    `Criticidade ${lastMonths[1].display}`, 'Proj. M√©dia'
  ];

  const theadHtml = `
    <tr>
      ${headCols.map((c, i) => `
        <th>
          ${c} <button class="filter-btn" data-column="${i}" style="border:none;background:none;size: 20px;">‚ñº</button>
          <div class="filter-popup" data-column="${i}" style="display:none;position:absolute;z-index:1000;background:white;border:1px solid #ccc;padding:10px;">
            <input type="text" class="popup-search form-control form-control-sm mb-2" placeholder="Pesquisar...">
            <div class="filter-options" style="max-height:150px;overflow:auto;"></div>
            <button class="apply-filter btn btn-sm btn-primary mt-2">Aplicar</button>
            <button class="clear-filter btn btn-sm btn-secondary mt-1">Limpar</button>
          </div>
        </th>`).join('')}
    </tr>`;
  $('#oltTable thead').html(theadHtml);

  let html = '';
  dadosDisponibilidade.forEach((it, rowIdx) => {
    html += '<tr>';
    html += `<td>${it['DDD'] || ''}</td>`;
    html += `<td>${it['MUNICIPIO'] || ''}</td>`;

    // Adiciona os valores de "Qtd Bairros" e "Parque"
    let siteKey = String(it['SITE'] || '').trim().toUpperCase();
    const siteExtra = window.siteExtraMap && siteKey ? window.siteExtraMap[siteKey] : null;
    html += `<td>${siteExtra && siteExtra['Qtd Bairro'] ? siteExtra['Qtd Bairro'] : '-'}</td>`;
    html += `<td>${siteExtra && siteExtra['Parque'] ? siteExtra['Parque'] : '-'}</td>`;

    html += `<td class="bairro-column">${siteExtra && siteExtra['Bairros'] ? siteExtra['Bairros'] : '-'}</td>`;
    html += `<td>${siteExtra && siteExtra['TAV?'] ? siteExtra['TAV?'] : 'N√£o'}</td>`;
    html += `<td>${siteExtra && siteExtra['Bairro Alto Valor'] ? siteExtra['Bairro Alto Valor'] : 'N√£o'}</td>`;
    html += `<td>${it['SITE'] || ''}</td>`;
    monthHeaders.forEach((m, colIdx) => {
      const val = it[m.key];
      const n = val == null || val === '' ? null : parseFloat(val.toString().replace(',', '.'));
      let bg = '';
      let color = '';
      if (n === 100) {
        bg = '#337031';
        color = '#ffffff';
      } else if (n > 98) {
        bg = '#00b050';
        color = '#ffffff';
      } else if (n > 96) {
        bg = '#ffff00';
        color = '#000000';
      } else if (n != null) {
        bg = '#ff0000';
        color = '#ffffff';
      }
      const disp = (n === 100 || n === 0) ? String(n) : n != null ? n.toFixed(2).replace('.', ',') : '';
      html += `<td class="month-cell" style="background-color:${bg}; color:${color}; cursor:pointer;" data-order="${n}" data-row="${rowIdx}" data-colkey="${m.key}" data-coldisplay="${m.display}" data-site="${it['SITE'] || ''}">${disp}</td>`;
    });
    dateHeaders.forEach(h => { html += formatCell(it[h.key], rowIdx, h.key, h.display, it['SITE']); });
    html += `<td>${it[`Criticidade ${lastMonths[0].display}`]}</td>`;
    html += `<td>${it[`Criticidade ${lastMonths[1].display}`]}</td>`;

    const projMedia = it['Proj. M√©dia'];
    let projValue = projMedia == null || projMedia === '' || projMedia === 0 || projMedia === '0' ? 100 : parseFloat(projMedia.toString().replace(',', '.'));
    let projBg = '';
    let projColor = '';
    if (projValue === 100) {
      projBg = '#337031';
      projColor = '#ffffff';
    } else if (projValue >= 98 && projValue < 100) {
      projBg = '#00b050';
      projColor = '#ffffff';
    } else if (projValue >= 96 && projValue < 98) {
      projBg = '#ffff00';
      projColor = '#000000';
    } else if (projValue < 96) {
      projBg = '#ff0000';
      projColor = '#ffffff';
    }
    let projDisplay = projValue === 100 ? '100' : (projMedia != null && projMedia !== '' ? projMedia : '');
    projDisplay = projDisplay.toString().replace('.', ',');
    html += `<td class="proj-media-cell" style="background-color:${projBg}; color:${projColor};" data-order="${projValue}">${projDisplay}</td>`;

    html += '</tr>';
  });
  $('#oltTable tbody').html(html);

  addCausaIndicators();

  table = $('#oltTable').DataTable({
    paging: true,
    pageLength: 20,
    ordering: true,
    order: [[5, 'asc']],
    scrollX: false,
    language: {
      paginate: { previous: 'Anterior', next: 'Pr√≥ximo' },
      info: 'Mostrando _START_ a _END_ de _TOTAL_',
      infoEmpty: 'Mostrando 0 a 0 de 0',
      zeroRecords: 'Nenhum registro encontrado',
      search: ''
    },
    columnDefs: [
      {
        targets: headCols.length - 1,
        type: 'num',
        orderDataType: 'dom-data-order'
      },
      { targets: '_all', orderable: false }
    ]
  });

  table.on('draw', function () {
    updateCardsComFiltros();
  });

  updateCards();

  $('#oltTable tbody').on('click', 'td', function () {
    const $cell = $(this);
    const rowIdx = $cell.data('row');
    const colKey = $cell.data('colkey');
    const colDisplay = $cell.data('coldisplay');
    const site = $cell.data('site');

    if (rowIdx !== undefined && colKey && site) {
      const rowData = dadosDisponibilidade[rowIdx];
      showEditModal(rowData, colKey, colDisplay, this);
    }
  });
}

    function addCausaIndicators() {
  $('#oltTable td.month-cell, #oltTable td.date-cell').each(function () {
    const $td = $(this);
    const rowIdx = $td.data('row');
    const colKey = $td.data('colkey');
    const site = $td.data('site');
    if (!site || !colKey) return;

    const id = btoa(`${site}|${colKey}`);

    db.ref('dispmovel/' + id).on('value', snap => {
  const val = snap.val();
  const existing = $td.find('.causa-indicator');
  const hasCausa = val && (val.causa1 || val.causa2 || val.causa3 || val.solucao);

  $td.css('position', 'relative');

  if (hasCausa && existing.length === 0) {
    $td.append('<span class="causa-indicator" style="position:absolute;top:3px;left:5px;width:20px;height:20px;background:#0011ff;border-radius:50%;display:inline-block;border:2px solid #fff;z-index:2;"></span>');
  } else if (!hasCausa && existing.length > 0) {
    existing.remove();
  }
});

  });
}

  function updateCards() {
      if (!dadosSitesBairro || !dadosDisponibilidade) {
        console.error('Dados indispon√≠veis para atualizar os cart√µes.');
        return;
      }

      const bairroSet = new Set(dadosSitesBairro.map(s => s.Site));
      const filtered = dadosDisponibilidade.filter(i => bairroSet.has(i.SITE));
      const total = filtered.length;

  const mesAtual = currentMonths.at(-1)?.toLowerCase();
  const crit2ColName = headCols.find(c =>
  c.toLowerCase().includes('criticidade') &&
  c.toLowerCase().includes(mesAtual)
);
 

  let crit = 0, alert = 0, nonc = 0;
  filtered.forEach(i => {
    const val = i[crit2ColName];
    if (val === 'Cr√≠tico') crit++;
    else if (val === 'Alerta') alert++;
    else nonc++;
  });

  $('#totalSitesCard').text(`Total de Sites: ${dadosDisponibilidade.length}`);
  $('#sitesBairroCard').text(`Total Sites Bairro: ${total}`);
  $('#criticalSitesCard').text(`Sites Cr√≠ticos: ${crit}`);
  $('#alertSitesCard').text(`Sites em Alerta: ${alert}`);
   $('#nonCriticalSitesCard').text(`Sites N√£o Cr√≠ticos: ${nonc}`);
}


function updateCardsComFiltros() {
  if (!table || !dadosSitesBairro) return;

  const filteredRows = table.rows({ search: 'applied' }).data().toArray();

  const siteIndex = headCols.findIndex(c => c === 'SITE');
  const bairroIndex = headCols.findIndex(c => c === 'Bairros');
  const siteBairroSet = new Set(dadosSitesBairro.map(s => s.Site));

  let total = filteredRows.length;
  let totalBairro = 0;
  const bairrosUnicos = new Set();

  filteredRows.forEach(row => {
    const site = $('<div>').html(row[siteIndex]).text().trim();
    const bairro = $('<div>').html(row[bairroIndex]).text().trim();
    if (siteBairroSet.has(site)) totalBairro++;
    if (bairro && bairro !== '-') bairrosUnicos.add(bairro); // Ignora valores "-"
  });

  $('#totalSitesCard').text(`Total de Sites: ${total}`);
  $('#sitesBairroCard').text(`Total Sites Bairro: ${totalBairro} / ${bairrosUnicos.size}`);
}


  

    function setupFilters() {
      function populate(selector, field) {
        const set = new Set(dadosDisponibilidade.map(i=>i[field]?.trim()));
        const drop = $(selector).empty();
        drop.append(`<div class="filter-item" data-value="select-all"><input type="checkbox" class="select-all-checkbox"> Selecionar Todos</div>`);
        set.forEach(v=>{ if(v) drop.append(`<div class="filter-item" data-value="${v}"><input type="checkbox" class="filter-checkbox" data-value="${v}"> ${v}</div>`); });
      }
      populate('#dddDropdown','DDD');
      populate('#muniDropdown','MUNICIPIO');
      populate('#siteDropdown','SITE');

      function setup(inputSel, dropSel, colIndex) {
        const input=$(inputSel), dropdown=$(dropSel), selected=new Set(); let focusIdx=-1;
        input.on('focus input', ()=>{
          dropdown.addClass('active');
          const q=input.val().toLowerCase();
          const items=dropdown.children().filter(function(){return $(this).text().toLowerCase().includes(q);});
          dropdown.children().hide(); items.show(); items.removeClass('focused');
          if(items.length){ focusIdx=0; $(items[0]).addClass('focused'); } else focusIdx=-1;
        });
        dropdown.on('click','.filter-item',function(e){ e.stopPropagation(); const cb=$(this).find('input'); const val=$(this).data('value');
          if(val==='select-all'){ const chk=cb.prop('checked'); dropdown.find('.filter-checkbox').prop('checked',chk);
            if(chk) dropdown.find('.filter-checkbox').each((_,c)=>selected.add($(c).data('value')));
            else selected.clear();
          } else {
            cb.prop('checked',!cb.prop('checked'));
            if(cb.prop('checked')) selected.add(val);
            else{ selected.delete(val); dropdown.find('.select-all-checkbox').prop('checked',false); }
          }
          table.column(colIndex).search([...selected].join('|'),true,false).draw();
        });
        input.on('keydown',e=>{
          const items=dropdown.children(':visible');
          if(e.key==='ArrowDown'){ e.preventDefault(); focusIdx=(focusIdx+1)%items.length; items.removeClass('focused'); $(items[focusIdx]).addClass('focused'); }
          else if(e.key==='ArrowUp'){ e.preventDefault(); focusIdx=(focusIdx-1+items.length)%items.length; items.removeClass('focused'); $(items[focusIdx]).addClass('focused'); }
          else if(e.key==='Enter'){ e.preventDefault(); if(focusIdx>=0) $(items[focusIdx]).trigger('click'); }
        });
        $(document).click(e=>{ if(!$(e.target).closest(inputSel+','+dropSel).length) dropdown.removeClass('active'); });
      }
      setup('#dddFilterInput','#dddDropdown',0);
      setup('#muniFilterInput','#muniDropdown',1);
      setup('#siteFilterInput','#siteDropdown',2);
    }

    

    function setupAdvancedFilters() {
  $('.filter-btn').off('click').on('click', function (e) {
    e.stopPropagation();
    $('.filter-popup, #filterContainer').hide();

    const index = $(this).data('column');
    let popup = $('#filterContainer');
    popup.empty();

    let header = $(
      `<div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-weight:bold;font-size:18px;">Filtro Avan√ßado</span>
        <button class="close-popup"
                style="width:32px;height:32px;border-radius:50%;background-color:#dee2e6;border:none;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;">
          &times;
        </button>
      </div>
      <hr style="margin:8px 0;">`
    );

    let searchInput = $('<input type="text" class="popup-search form-control form-control-sm mb-2" placeholder="Pesquisar valor...">');

    let emptyFilter = $(
      `<div class="mb-2" style="font-size:15px;">
        <label><input type="checkbox" class="filter-empty"> Somente vazios</label>
        <label style="margin-left:10px;"><input type="checkbox" class="filter-notempty"> Somente preenchidos</label>
      </div>`
    );

    let colorFilter = null;
    if (/disp|proj|%|m√©dia|estimulada|^\d{2}\/\d{2}|^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)$/i.test(headCols[index])) {
      colorFilter = $(
        `<div class="mb-2" style="font-size:15px;">
          <span style="margin-right:8px;">Cor:</span>
          <span class="color-dot" data-color="darkgreen" style="background:#337031;" title="√ìtimo"></span>
          <span class="color-dot" data-color="lightgreen" style="background:#00b050;" title="Bom"></span>
          <span class="color-dot" data-color="orange" style="background:#ffff00;" title="Alerta"></span>
          <span class="color-dot" data-color="red" style="background:#ff0000;" title="Cr√≠tico"></span>
          <span class="color-dot" data-color="all" style="background:#ccc;border:1px solid #888;" title="Todas"></span>
        </div>`
      );
    }

    let filterOptions = $('<div class="filter-options mb-2" style="max-height:180px;overflow:auto;border:1px solid #eee;border-radius:6px;padding:6px;background:#fafbfc;"></div>');
    const values = new Set();


table.column(index, { search: 'applied' }).data().each(function (val) {
  const texto = $('<div>').html(val).text().trim();
  if (texto) values.add(texto);
});

    [...values].sort().forEach(v => {
      filterOptions.append(`<div><label><input type="checkbox" value="${v}"> ${v}</label></div>`);
    });

    let sortBtns = $(
      `<div class="filter-sort mb-2" style="font-size:15px;">
        <span style="margin-right:8px;">Ordenar:</span>
        <button class="btn btn-sm btn-outline-primary sort-asc">A-Z/‚Üë</button>
        <button class="btn btn-sm btn-outline-primary sort-desc">Z-A/‚Üì</button>
        <button class="btn btn-sm btn-outline-secondary sort-clear">Limpar</button>
      </div>`
    );

    let applyButton = $('<button class="apply-filter btn btn-success w-100 mt-2">Aplicar Filtro</button>');
    let clearButton = $('<button class="clear-filter btn btn-secondary w-100 mt-1">Limpar Filtros</button>');

    popup.append(header, searchInput, emptyFilter);
    if (colorFilter) popup.append(colorFilter);
    popup.append(filterOptions, sortBtns, applyButton, clearButton);

    popup.css({
      position: 'absolute',
      zIndex: 9999,
      top: e.pageY + 10,
      left: e.pageX + 190,
      minWidth: '260px',
      maxWidth: '350px',
      background: '#fff',
      border: '1px solid #bbb',
      borderRadius: '10px',
      boxShadow: '0 4px 18px rgba(0,0,0,0.13)',
      padding: '18px 18px 12px 18px',
      display: 'block',
      zoom: '190%'
    }).data('column', index);

    popup.find('.close-popup').on('click', () => popup.hide());

    searchInput.on('keyup', function () {
      let val = $(this).val().toLowerCase();
      filterOptions.find('div').each(function () {
        $(this).toggle($(this).text().toLowerCase().includes(val));
      });
    });

    popup.find('.filter-empty').on('change', function () {
      if (this.checked) popup.find('.filter-notempty').prop('checked', false);
    });
    popup.find('.filter-notempty').on('change', function () {
      if (this.checked) popup.find('.filter-empty').prop('checked', false);
    });

    if (colorFilter) {
      colorFilter.find('.color-dot').on('click', function () {
        colorFilter.find('.color-dot').removeClass('selected');
        $(this).addClass('selected');
      });
    }

    sortBtns.find('.sort-asc').on('click', () => table.order([index, 'asc']).draw());
    sortBtns.find('.sort-desc').on('click', () => table.order([index, 'desc']).draw());
    sortBtns.find('.sort-clear').on('click', () => table.order([]).draw());

    applyButton.on('click', function () {
      let regex = '';
      if (popup.find('.filter-empty').prop('checked')) {
        regex = '^\\s*$';
      } else if (popup.find('.filter-notempty').prop('checked')) {
        regex = '^\\s*\\S+';
      } else {
        const vals = filterOptions.find('input[type="checkbox"]:checked').map(function () {
          return '^' + $.fn.dataTable.util.escapeRegex($(this).val()) + '$';
        }).get();
        regex = vals.join('|');
      }

      if (colorFilter) {
        const selectedColor = colorFilter.find('.color-dot.selected').data('color');
        if (selectedColor && selectedColor !== 'all') {
          const colorRegex = {
            darkgreen: '^100$',
            lightgreen: '(^9[8-9](,\\d\\d)?$|^99(,0{1,2})?$)',
            orange: '(^9[7](,\\d\\d)?$|^96(,\\d\\d)?$)',
            red: '(^([0-8]?\\d(,\\d\\d)?|9[0-5](,\\d\\d)?)$)'
          }[selectedColor];
          regex = regex ? `(?=.*${regex})${colorRegex}` : colorRegex;
        }
      }

      table.column(index).search(regex, true, false).draw();
      popup.hide();
    });

    clearButton.on('click', function () {
      table.column(index).search('').draw();
      filterOptions.find('input[type="checkbox"]').prop('checked', false);
      popup.find('.filter-empty, .filter-notempty').prop('checked', false);
      if (colorFilter) colorFilter.find('.color-dot').removeClass('selected');
      popup.hide();
    });
  });

  $(document).off('click.filtroFechamento').on('click.filtroFechamento', function (e) {
    const $target = $(e.target);
    if (
      !$target.closest('.filter-btn').length &&
      !$target.closest('#filterContainer').length
    ) {
      $('#filterContainer').hide();
    }
  });
}



function setupActions() {
$('#clearFilters').on('click', () => {
  table.search(''); // limpa filtro global

  table.columns().every(function (colIdx) {
    const colName = headCols[colIdx];
    if (colName === 'DDD' && filtroDddPorBotao) {
      return; // mant√©m filtro de DDD se veio de ABI/TEL
    }
    this.search('');
  });

  table.order([5, 'asc']).draw();

  $('.filter-btn').removeClass('filtered');
  $('.filter-checkbox, .select-all-checkbox').prop('checked', false);
  $('.dropdown-list').removeClass('active');
});


  $('#exportExcel').on('click', () => {
    const data = table.rows({ search: 'applied' }).nodes().toArray()
      .map(r => $(r).find('td').toArray().map(c => $(c).text().trim()));
    const ws = XLSX.utils.aoa_to_sheet([headCols, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Disponibilidade');
    XLSX.writeFile(wb, 'Disponibilidade_M√≥vel.xlsx');
  });

  $('#exportCausas').on('click', async () => {
  const rows = table.rows({ search: 'applied' }).nodes().toArray();
  const exportData = [];

  if (!rows.length) {
    return;
  }

  for (let i = 0; i < rows.length; i++) {
    const tds = $(rows[i]).find('td');
    const site = $(tds[5]).text().trim();
    const rowIdx = $(tds[0]).closest('tr').index();
    const rowData = dadosDisponibilidade[rowIdx];

    if (!site || !rowData) {
      continue;
    }

    for (const month of currentMonths) {
      const colKey = month;
      const id = btoa(`${site.trim()}|${colKey.trim()}`);

      try {
        const snap = await db.ref('dispmovel/' + id).once('value');
        const val = snap.val();

        if (val && (val.causa1 || val.causa2 || val.causa3 || val.solucao)) {
          exportData.push({
            SITE: site,
            MUNICIPIO: rowData['MUNICIPIO'] || '',
            M√äS: colKey,
            DISPONIBILIDADE: rowData[colKey] || '',
            CAUSA_1: val.causa1 || '',
            CAUSA_2: val.causa2 || '',
            CAUSA_3: val.causa3 || '',
            A√á√ÉO_REALIZADA: val.solucao || '',
            RESPONS√ÅVEL: val.responsavel || ''
          });
        }
      } catch (err) {
      }
    }
  }

  if (exportData.length === 0) {
    alert("Nenhuma causa preenchida encontrada.");
    return;
  }

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Causas');
  XLSX.writeFile(workbook, 'Causas_Com_Disponibilidade.xlsx');
});



headCols = headCols.map(c => c.replace(/\s*‚ñº$/, '').trim());

const siteIdx = headCols.findIndex(c => c === 'SITE');

const crit2Idx = headCols.findIndex(c => c.startsWith('Criticidade') && c.includes(currentMonths.at(-1)));

const bairroRegex = dadosSitesBairro.map(s => `^${s.Site}$`).join('|');

function cardFilter(id, crit, showAll = false) {
  $(id).off('click').on('click', () => {
    // Obtenha os filtros j√° aplicados
    const currentSearch = table.column(siteIdx).search() || '';
    const bairroRegex = dadosSitesBairro.map(s => `^${s.Site}$`).join('|');

    // Combine o filtro atual com o filtro do card
    let newSearch = currentSearch;
    if (!showAll) {
      newSearch = currentSearch
        ? `(${currentSearch})|(${bairroRegex})`
        : bairroRegex;
    }

    // Aplique o filtro combinado
    table.column(siteIdx).search(newSearch, true, false);

    if (crit !== null) {
      table.column(crit2Idx).search(`^${crit}$`, true, false);
    }

    table.draw();
  });
}

  cardFilter('#totalSitesCard', null, true);
  cardFilter('#sitesBairroCard', null);
  cardFilter('#criticalSitesCard', 'Cr√≠tico');
  cardFilter('#alertSitesCard', 'Alerta');
  cardFilter('#nonCriticalSitesCard', 'N√£o Cr√≠tico');
}

    const firebaseConfig = {
  apiKey: "AIzaSyC0WOkW73igO0B2LFVKDJr7uveWPf4d4Uk",
  authDomain: "database-dispmovel.firebaseapp.com",
  databaseURL: "https://database-dispmovel-default-rtdb.firebaseio.com",
  projectId: "database-dispmovel",
  storageBucket: "database-dispmovel.firebasestorage.app",
  messagingSenderId: "245395632820",
  appId: "1:245395632820:web:2f1068109246d5d9541de1",
  measurementId: "G-2C1X826GKM"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentEdit = null;


    function showEditModal(rowData, colKey, colDisplay, cellElem) {
  currentEdit = { rowData, colKey, cellElem };
  const disponibilidade = rowData[colKey]; 
  const id = btoa(`${rowData['SITE']}|${colKey}`);

  // Cor conforme disponibilidade
  let disponibilidadeColor = '';
  const n = parseFloat(disponibilidade.toString().replace(',', '.'));
  if (n === 100) {
    disponibilidadeColor = '#337031'; 
  } else if (n > 98) {
    disponibilidadeColor = '#00b050'; 
  } else if (n > 96) {
    disponibilidadeColor = '#ffff00'; 
  } else {
    disponibilidadeColor = '#ff0000'; 
  }

  // T√≠tulo com bot√£o de limpar
  $('#modalTitle').html(`
  <div style="display: flex; align-items: center; gap: 8px;">
    <button id="limparCausaBtn" style="
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
    " title="Limpar dados salvos">
      üóëÔ∏è
    </button>
    <span>Editar: ${rowData['SITE']} - ${colDisplay} - <span style="color:${disponibilidadeColor}; font-weight:bold;">${disponibilidade}%</span></span>
  </div>
`);

  $('#modalMsg').hide();
  $('#editForm')[0].reset();

  // Desabilita campos inicialmente
  $('#causaInput1, #causaInput2,#causaInput3, #solucaoInput, #responsavelInput').prop('disabled', true);
  $('#editBtn').text('Editar');

  // Preenche dados do Firebase
  db.ref('dispmovel/' + id).once('value').then(snap => {
    const val = snap.val() || {};

    function setCausaSelect(num, value) {
      const select = $(`#causaInput${num}`);
      const outro = $(`#causaOutro${num}`);
      const options = Array.from(select[0].options).map(opt => opt.value);
      if (value && !options.includes(value)) {
        select.val('Outro');
        outro.val(value).show();
      } else {
        select.val(value || '');
        outro.val('').hide();
      }
    }
    setCausaSelect(1, val.causa1);
    setCausaSelect(2, val.causa2);
    setCausaSelect(3, val.causa3);

    $('#solucaoInput').val(val.solucao || '');
    $('#responsavelInput').val(val.responsavel || '');
    $('#editModal').css('display', 'flex');

    // For√ßa ajuste do tamanho dos textareas
    setTimeout(() => {
      document.querySelectorAll('textarea.auto-resize').forEach(el => {
        el.style.height = 'auto';
        el.style.height = `${el.scrollHeight}px`;
      });
    }, 0);
  });

  // Evento do bot√£o üóëÔ∏è
  $('#limparCausaBtn').off('click').on('click', function () {
    if (confirm('Tem certeza que deseja apagar os dados dessa c√©lula?')) {
      db.ref('dispmovel/' + id).remove().then(() => {
        alert('Informa√ß√µes apagadas com sucesso!');
        $('#editModal').hide();
      }).catch(err => {
        alert('Erro ao apagar: ' + err.message);
      });
    }
  });
}
    $('#closeModalBtn').on('click', () => $('#editModal').hide());

    $('#editForm').on('submit', function(e) {
      e.preventDefault();
      if (!currentEdit) return;
      const { rowData, colKey, cellElem } = currentEdit;
      const id = btoa(`${rowData['SITE']}|${colKey}`);

      function getCausaValue(num) {
        const select = $(`#causaInput${num}`);
        const outro = $(`#causaOutro${num}`);
        if (select.val() === 'Outro') {
          return outro.val() || 'Outro';
        }
        return select.val();
      }

      const data = {
        causa1: getCausaValue(1),
        causa2: getCausaValue(2),
        causa3: getCausaValue(3),
        solucao: $('#solucaoInput').val(),
        responsavel: $('#responsavelInput').val()
      };
      db.ref('dispmovel/' + id).set(data, err => {
        if (!err) {
          $('#modalMsg').show().delay(1200).fadeOut();
          $(cellElem).attr('data-hasinfo', '1');
        }
      });
    });
    $('#editBtn').on('click', function(){
      const inputs = $('#causaInput1, #causaInput2, #causaInput3, #solucaoInput, #responsavelInput');
      const isDisabled = inputs.prop('disabled');
      inputs.prop('disabled', !isDisabled);
      $(this).text(isDisabled ? 'Bloquear' : 'Editar');
    });



    document.addEventListener('DOMContentLoaded', function () {
    const causas = [1, 2, 3];

    causas.forEach(num => {
      const select = document.getElementById(`causaInput${num}`);
      const outro = document.getElementById(`causaOutro${num}`);

      select.addEventListener('change', function () {
        if (this.value === 'Outro') {
          outro.style.display = 'block';
          outro.required = true;
        } else {
          outro.style.display = 'none';
          outro.required = false;
          outro.value = '';
        }
      });
    });

    document.getElementById('editBtn').addEventListener('click', () => {
    causas.forEach(num => {
        document.getElementById(`causaInput${num}`).disabled = false;
        document.getElementById(`causaOutro${num}`).disabled = false;
      });

      document.getElementById('solucaoInput').disabled = false;
      document.getElementById('responsavelInput').disabled = false;
    });
  });


  document.addEventListener('DOMContentLoaded', function () {
    let nomeUsuario = localStorage.getItem("nomeUsuario");

    if (!nomeUsuario) {
      const agente = navigator.userAgent;
      console.log("Navegador e sistema detectados:", agente); 

      nomeUsuario = prompt("Digite seu nome (isso ser√° salvo no navegador):");
      if (nomeUsuario) {
        localStorage.setItem("nomeUsuario", nomeUsuario);
      }
    }

    document.getElementById('editBtn').addEventListener('click', () => {
      const input = document.getElementById('responsavelInput');
      input.disabled = false;

      if (nomeUsuario) {
        input.value = nomeUsuario;
      }
    });
  });

  document.addEventListener('input', function (event) {
    if (event.target.classList.contains('auto-resize')) {
      event.target.style.height = 'auto'; // Redefine a altura
      event.target.style.height = `${event.target.scrollHeight}px`; // Ajusta para o conte√∫do
    }
  });

  function setupAbiTelButtons() {const dddIdx = headCols.findIndex(c => c === 'DDD');

$('#abiBtn').off('click').on('click', function () {
  table.column(dddIdx).search('^11$', true, false).draw();
  filtroDddPorBotao = true;

  $('#abiBtn').addClass('selected-btn');
  $('#telBtn, #spiBtn').removeClass('selected-btn');
});

$('#telBtn').off('click').on('click', function () {
  table.column(dddIdx).search('^(?!11$).*$', true, false).draw();
  filtroDddPorBotao = true;

  $('#telBtn').addClass('selected-btn');
  $('#abiBtn, #spiBtn').removeClass('selected-btn');
});

$('#spiBtn').off('click').on('click', function () {
  table.column(dddIdx).search('').draw();
  filtroDddPorBotao = false;

  $('#abiBtn, #telBtn, #spiBtn').removeClass('selected-btn');
});

  function atualizarFiltrosAvancados() {
    // For√ßa atualiza√ß√£o das op√ß√µes vis√≠veis nas popups de filtro avan√ßado
    $('.filter-btn').each(function () {
      const colIndex = $(this).data('column');
      const popup = $('.filter-popup[data-column="' + colIndex + '"]');
      const optionsDiv = popup.find('.filter-options');

      if (optionsDiv.length) {
        const uniqueVals = new Set();
        table.column(colIndex, { search: 'applied' }).data().each(function (val) {
          const texto = $('<div>').html(val).text().trim();
          if (texto) uniqueVals.add(texto);
        });

        optionsDiv.empty();
        [...uniqueVals].sort().forEach(v => {
          optionsDiv.append(`<div><label><input type="checkbox" value="${v}"> ${v}</label></div>`);
        });
      }
    });
  }

  $('#abiBtn').off('click').on('click', function () {
    table.column(dddIdx).search('^11$', true, false).draw();
    filtroDddPorBotao = true;
    $('#abiBtn').addClass('selected-btn');
    $('#telBtn, #spiBtn').removeClass('selected-btn');
    setTimeout(atualizarFiltrosAvancados, 300); // Aguarda draw da tabela
  });

  $('#telBtn').off('click').on('click', function () {
    table.column(dddIdx).search('^(?!11$).*$', true, false).draw();
    $('#telBtn').addClass('selected-btn');
    $('#abiBtn, #spiBtn').removeClass('selected-btn');
    setTimeout(atualizarFiltrosAvancados, 300);
  });

  $('#spiBtn').off('click').on('click', function () {
    table.column(dddIdx).search('').draw();
    $('#abiBtn, #telBtn, #spiBtn').removeClass('selected-btn');
    setTimeout(atualizarFiltrosAvancados, 300);
  });
}


// Chame ap√≥s a tabela ser inicializada
$(document).ready(function() {
  // Aguarda a tabela ser criada
  const interval = setInterval(function() {
    if (typeof table !== 'undefined' && table) {
      setupAbiTelButtons();
      clearInterval(interval);
    }
  }, 200);
});

  </script>

<script>
  fetch('https://grupotel-web.github.io/RElTUExPVkVMA/dados.json', { method: 'HEAD' })
    .then(response => {
      const lastModified = response.headers.get('Last-Modified');
      if (lastModified) {
        const dataFormatada = new Date(lastModified).toLocaleString('pt-BR');
        document.getElementById('updateInfo').textContent = `Atualizado em: ${dataFormatada}`;
      } else {
        document.getElementById('updateInfo').textContent = `Data de atualiza√ß√£o indispon√≠vel`;
      }
    })
    .catch(err => {
      document.getElementById('updateInfo').textContent = `Erro ao obter atualiza√ß√£o`;
      console.error('Erro ao buscar cabe√ßalho do JSON:', err);
    });
</script>
</body>
</html>
